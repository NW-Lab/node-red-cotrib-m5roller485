# M5-Roller485 Node

Node-RED MCU用のM5Stack Roller485制御ノードの実装詳細

## ノード概要

このノードは、M5Stack Roller485ユニットをI2C経由で制御し、指定された角度に回転させます。
FOC(Field Oriented Control)による位置制御モードで動作し、高精度な位置決めが可能です。

## 入力

### msg.payload

- **型**: Number
- **範囲**: -360 〜 360
- **単位**: 度 (degrees)
- **説明**: 回転させる角度を指定します。範囲外の値は無視されます。

### 入力例

```javascript
// 正の角度: 時計回り
msg.payload = 90;   // 90度回転
msg.payload = 180;  // 180度回転
msg.payload = 360;  // 360度回転(1回転)

// 負の角度: 反時計回り
msg.payload = -90;  // -90度回転
msg.payload = -180; // -180度回転
```

## 出力

このノードには出力はありません(0出力)。

## プロパティ

### I2Cアドレス (address)
- **デフォルト**: 0x64 (100)
- **説明**: M5-Roller485のI2Cアドレス。通常は変更不要です。

### SDAピン (sda)
- **デフォルト**: 21
- **説明**: I2C通信に使用するSDAピン番号。デバイスの配線に合わせて変更してください。

### SCLピン (scl)
- **デフォルト**: 22
- **説明**: I2C通信に使用するSCLピン番号。デバイスの配線に合わせて変更してください。

### I2C速度 (hz)
- **デフォルト**: 400000 (400kHz)
- **説明**: I2C通信の速度。通常は変更不要です。

### 電流制限 (current)
- **デフォルト**: 1000 (10.00A)
- **範囲**: -1200 〜 1200
- **単位**: 0.01A
- **説明**: モーターの最大電流制限。値 × 0.01A が実際の電流値になります。

## 動作詳細

### モーター制御シーケンス

ノードは以下の6ステップでM5-Roller485を制御します:

1. **モード設定**: 位置制御モード(0x02)を I2C_MODE_REG(0x01) に書き込み
2. **位置設定**: 目標位置を I2C_POS_REG(0x80) に書き込み
3. **電流設定**: 電流制限値を I2C_POS_MAX_CURRENT_REG(0x20) に書き込み
4. **モーター起動**: I2C_OUTPUT_REG(0x00) に 0x01 を書き込んでモーター出力ON
5. **待機**: 2秒間待機(移動完了まで)
6. **モーター停止**: I2C_OUTPUT_REG(0x00) に 0x00 を書き込んでモーター出力OFF

### 角度→位置変換

M5-Roller485の位置エンコーダは36000 positions = 360度の分解能を持ちます。

```javascript
// 変換式
const POS_PER_DEGREE = 100;  // 100 pos/度
position = angle × POS_PER_DEGREE × 100;

// 例: 90度の場合
position = 90 × 100 × 100 = 900000;
```

### I2Cレジスタマップ

| レジスタ名 | アドレス | 説明 |
|-----------|---------|------|
| I2C_OUTPUT_REG | 0x00 | モーター出力 ON/OFF |
| I2C_MODE_REG | 0x01 | 動作モード (0x02=位置モード) |
| I2C_POS_MAX_CURRENT_REG | 0x20 | 位置モード電流制限 |
| I2C_POS_REG | 0x80 | 目標位置設定 |

### モーター自動停止について

移動完了後、モーターは自動的に停止(出力OFF)されます。これは以下の理由によります:

- **発熱防止**: 位置保持のための電流(保持電流)が流れ続けると、モーターが発熱します
- **省電力**: 不要な電力消費を防ぎます
- **安全性**: 長時間の通電による故障リスクを軽減します

## I2C通信について

### I2Cの初期化

```javascript
this.i2c = new device.io.I2C({
  sda: this.config.sda,
  scl: this.config.scl,
  hz: this.config.hz,
  address: this.config.address
});
```

### データ書き込み

4バイトのリトルエンディアン形式でデータを送信します:

```javascript
const buffer = new ArrayBuffer(4);
const view = new DataView(buffer);
view.setInt32(0, value, true);  // true = little endian
this.i2c.write(register, buffer);
```

## トラブルシューティング

### モーターが動かない場合

1. **I2C配線を確認**: SDA/SCLピンが正しく接続されているか確認
2. **I2Cアドレスを確認**: デフォルトの0x64で正しいか確認
3. **電源を確認**: M5-Roller485に十分な電源が供給されているか確認
4. **角度範囲を確認**: -360〜360度の範囲内の値を送信しているか確認

### 動きが不安定な場合

1. **電流制限を調整**: currentプロパティで電流を下げてみる
2. **I2C速度を下げる**: hzプロパティを100000 (100kHz)に変更してみる
3. **配線の長さを確認**: I2Cは長い配線に弱いため、なるべく短く

### 発熱する場合

- モーターは移動後、自動的に停止されますが、頻繁に動かすと発熱することがあります
- 連続使用時は、適度に間隔を空けてください

## 制限事項

- **単一動作**: 移動中に新しい角度指定を送信しても、前の動作が完了するまで無視されます
- **固定待機時間**: 移動完了の検出は位置フィードバックではなく、固定2秒の時間ベースです
- **MCU専用**: Node-RED MCU環境でのみ動作します(通常のNode-REDでは動作しません)

## 参考実装

このノードの実装は、以下のArduinoライブラリを参考にしています:

- [M5Unit-Roller](https://github.com/m5stack/M5Unit-Roller) - M5Stack公式Arduinoライブラリ

I2Cレジスタアドレスやデータフォーマットは、上記ライブラリのヘッダファイルから取得しています。
